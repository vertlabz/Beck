generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Use DIRECT_URL for migrations/Introspection when your DATABASE_URL uses pooling (recommended for Neon + serverless).
  // If you don't have a separate direct URL, set DIRECT_URL = DATABASE_URL.
  directUrl = env("DIRECT_URL")
}

enum AppointmentStatus {
  SCHEDULED
  CANCELED
  DONE
}

model User {
  id             String   @id @default(uuid())
  name           String
  email          String   @unique
  password       String
  isProvider     Boolean  @default(false)
  maxBookingDays Int      @default(7) // limite de dias para agendar
  cancelBookingHours Int  @default(2) // limite de horas antes para cancelar

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  services               Service[]
  appointmentsAsCustomer Appointment[] @relation("customerAppointments")
  appointmentsAsProvider Appointment[] @relation("providerAppointments")
  providerAvailabilities ProviderAvailability[]
  providerBlocks         ProviderBlock[]
  tokens                 Token[]
}

model Service {
  id         String   @id @default(uuid())
  providerId String
  provider   User     @relation(fields: [providerId], references: [id])
  name       String
  duration   Int      // minutos
  price      Float
  createdAt  DateTime @default(now())

  appointments Appointment[]
}

model Appointment {
  id         String            @id @default(uuid())
  date       DateTime
  status     AppointmentStatus @default(SCHEDULED)
  customerId String
  providerId String
  serviceId  String?
  notes      String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  customer User     @relation("customerAppointments", fields: [customerId], references: [id])
  provider User     @relation("providerAppointments", fields: [providerId], references: [id])
  service  Service? @relation(fields: [serviceId], references: [id])

  @@index([providerId, date])
  @@index([customerId, date])
}

model ProviderAvailability {
  id         String   @id @default(uuid())
  providerId String
  provider   User     @relation(fields: [providerId], references: [id])
  weekday    Int      // 0 = domingo ... 6 = s√°bado
  startTime  String   // "HH:MM"
  endTime    String   // "HH:MM"
  createdAt  DateTime @default(now())
}

model ProviderBlock {
  id         String   @id @default(uuid())
  providerId String
  provider   User     @relation(fields: [providerId], references: [id])
  startAt    DateTime
  endAt      DateTime
  reason     String?
  createdAt  DateTime @default(now())

  @@index([providerId, startAt, endAt])
}

model Token {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, type, expiresAt])
}
